steps:
  - template: "expose-pds-variables-and-commands.yml"

  - bash: poetry install
    workingDirectory: $(ARTIFACT_PATH)
    displayName: Setup tests

  - bash: |
      export APIGEE_API_TOKEN="$(secret.AccessToken)"
      export APIGEE_ACCESS_TOKEN="$(secret.AccessToken)"
      export OAUTH_BASE_URI="https://$(ENVIRONMENT).api.service.nhs.uk"
      export OAUTH_PROXY="oauth2-mock"
      export TEST_PATIENT_ID="$(TEST_PATIENT_ID)"
      export INTERNAL_DEV_ASID="$(INTERNAL_DEV_ASID)"
      export PDS_CALLBACK_HYPOTHESIS_DIAGNOSTIC="true"

      python -V
      poetry --version
      poetry show requests urllib3 certifi pytest
      poetry run pytest -s -v tests/functional/test_patient_create.py::test_post_patient_rate_limit --api-name=personal-demographics-service --proxy-name "$(FULLY_QUALIFIED_SERVICE_NAME)" --junitxml=tests/patient-create-diagnostics-test-report.xml --reruns 0
    displayName: Run post patient callback diagnostics
    workingDirectory: "$(ARTIFACT_PATH)"

  - task: PublishTestResults@2
    displayName: "Publish post patient diagnostics test results"
    inputs:
      testResultsFiles: $(ARTIFACT_PATH)/tests/patient-create-diagnostics-test-report.xml
      failTaskOnFailedTests: true

  - task: PublishPipelineArtifact@1
    displayName: 'Publish post patient diagnostics logs as an artifact'
    condition: in(variables['Agent.JobStatus'], 'Succeeded', 'SucceededWithIssues', 'Failed')
    inputs:
      targetPath: $(ARTIFACT_PATH)/tests/patient-create-diagnostics-test-report.xml
      artifact: postPatientDiagnosticsTestReport
