name: "$(SourceBranchName)+$(BuildID)"

trigger: none
pr: none

schedules:
  - cron: 0 9 1-7 * 3
    displayName: The first Wednesday of each month
    branches:
      include: ['master']
    always: true

resources:
  repositories:
    - repository: common
      type: github
      name: NHSDigital/api-management-utils
      ref: refs/heads/edge
      endpoint: NHSDigital

pool:
  name: 'AWS-ECS'

# TODO - swap for a matrix for multiple environments
variables:
  - template: project.yml
  - name: environment
    value: internal-dev
  - name: FULLY_QUALIFIED_SERVICE_NAME
    value: personal-demographics-internal-dev

steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.9'
      addToPath: true
      architecture: 'x64'

  - bash: poetry install
    workingDirectory: $(Pipeline.Workspace)/s
    displayName: Install poetry

  - template: "azure/components/aws-assume-role.yml@common"
    parameters:
     role: "auto-ops"
     profile: "apm_ptl"

  # TODO - need to test with apigee-prod env such as INT to check if different secret paths are required
  # and, moreover, whether it's possible to get a token for Apigee prod
  # if not possible, may ultimately need to be a manual process, as the key requirement for this work is being able
  # to view the prod values
  - template: azure/components/get-aws-secrets-and-ssm-params.yml@common
    parameters:
     config_ids:
      - /ptl/azure-devops/apigee-nonprod/APIGEE_USERNAME
     secret_ids:
     - ptl/azure-devops/apigee-nonprod/APIGEE_OTP_KEY
     - ptl/azure-devops/apigee-nonprod/APIGEE_PASSWORD

  - template: azure/components/get-mfa-code.yml@common
    parameters:
     apigee_otp_key: $(APIGEE_OTP_KEY)

  - template: azure/components/get-access-token.yml@common
    parameters:
     apigee_username: $(APIGEE_USERNAME)
     apigee_password: $(APIGEE_PASSWORD)

  - bash: |
      export APIGEE_ACCESS_TOKEN="$(secret.AccessToken)"

      poetry run python scripts/find_apps_with_custom_flow_var.py -e nhsd-nonprod -p "$(FULLY_QUALIFIED_SERVICE_NAME)" -k pds
    workingDirectory: $(Pipeline.Workspace)/s
    displayName: Discover Apigee apps that have a value set for the pds apim flow variable or ratelimiting
