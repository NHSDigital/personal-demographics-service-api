parameters:
  - $ref: '#/components/parameters/BearerAuthorization'
  - $ref: '#/components/parameters/RoleId'
  - $ref: '#/components/parameters/RequestID'
  - $ref: '#/components/parameters/CorrelationID'
  - $ref: '#/components/parameters/NHSD-End-User-Organisation-ODS'
get:
    summary: Get a patient's coverage
    operationId: get-coverage
    description: |
      ## Overview
      Use this endpoint to get a patient's European Health Insurance Card (EHIC) details. Use the patient's NHS number as the identifier for coverage.

      This endpoint only gives EHIC data in the coverage data field. A patient may have other financial coverage, like insurance, but this information will not be returned by PDS. 

      You can only use this endpoint if you are using patient access mode. 
        
      ## Superseded patients
      Some patients are marked as superseded. This means that the original patient details are no longer valid and have been replaced with different details.

      When PDS tries to get the EHIC details using the NHS number of a superseded record, it will return the EHIC details of the latest record. You can see this by comparing the value used in the query with the value returned in the response body.

      ## Restricted patients
      Some patients are tagged as [restricted](https://digital.nhs.uk/services/demographics/restricting-access-to-a-patients-demographic-record) and are sometimes known as sensitive patients. 
      
      ## Mandatory fields
      The only mandatory EHIC field is the institution ID, `ehicDetails.InstitutionID`. If this field on the patient's record is empty, PDS will not return the patient's EHIC information. If any other EHIC field on the patient's record is empty, PDS will return the patient's EHIC information with the missing fields blank.

      ## Sandbox test scenarios
        You can test the following scenarios in our sandbox environment:

        | Scenario                        | Request                                       | Response                                                      |
        | ------------------------------- | --------------------------------------------- | ------------------------------------------------------------- |
        | xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx  | `id`=``                                       | xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx |
        | xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx  | `id`=``                                       | xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx |
        | xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx  | `id`=``                                       | xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx |
        | xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx  | `id`=``                                       | xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx |

        You can try out the sandbox by selecting the 'Try' button on this page.

        Alternatively, you can try out the sandbox using our Postman collection:
        
        [![Run in Postman](https://run.pstmn.io/button.svg)](https://)

   
    parameters:
      BeneficiaryIdentifier:
        name: beneficiary:identifier
        description: |
          The NHS number that identifies the holder/beneficiary of the coverage.
        examples:
          ehic_holder:
            value: 9733162868
            summary: Returns a bundle that contains a Coverage resource for the patient with NHS number 9733162868.
          no_ehic:
            value: 9733162876
            summary: Returns an empty bundle, alongside a meta object that can be used to apply an update to the patient's coverage.
        in: query
        required: true
        schema:
          type: string
    responses:
      '200':
        description: |
          A completed search for coverage. This will contain zero or one Coverage resources in the Bundle.

        headers:
          X-Correlation-Id:
            $ref: '#/components/headers/X-Correlation-Id'
          X-Request-Id:
            $ref: '#/components/headers/X-Request-Id'
        content:
          application/fhir+json:
            schema:
              $ref: 'components/schemas/CoverageSearch.yaml'

      '4XX':
        description: |
            An error occurred as follows:

            | HTTP status | Error code                 | Description                                                                                                                                |
            | ----------- | -------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------ |
            | 400         | INVALID_SEARCH_DATA	       | Invalid combination of search parameters. For details, see the `diagnostics` field.
            | 400         | MISSING_VALUE              | Missing header or query parameter. For details, see the `diagnostics` field.
            | 400         | INVALID_VALUE              | Invalid header or query parameter. For details, see the `diagnostics` field.
            | 401         | ACCESS_DENIED     	       | Access token missing, invalid or expired, or calling application not configured for this operation.
            | 403         | ACCESS_DENIED     	       | User cannot perform this operation.
            | 404         | RESOURCE_NOT_FOUND         | Patient does not exist for given NHS number.
            | 404         | INVALIDATED_RESOURCE       | Patient did exist for given NHS number, but has been invalidated and not superseded by another NHS number.
            | 408         | UNABLE_TO_CALL_SERVICE     | The downstream domain processing has not completed within the configured timeout period.
            | 429         | TOO_MANY_REQUESTS          | You have exceeded your application's [rate limit](https://digital.nhs.uk/developer/guides-and-documentation/reference-guide#rate-limits).

        headers:
          X-Correlation-Id:
            $ref: '#/components/headers/X-Correlation-Id'
          X-Request-Id:
            $ref: '#/components/headers/X-Request-Id'

        content:
          application/fhir+json:
            schema:
              $ref: '#/components/schemas/OperationOutcome'
            example:
              resourceType: OperationOutcome
              issue:+-
                - severity: error
                  code: forbidden
                  details:
                    coding:
                      - system: 'https://fhir.nhs.uk/R4/CodeSystem/Spine-ErrorOrWarningCode'
                        version: '1'
                        code: ACCESS_DENIED
                        display: Cannot GET resource with user-restricted access token
                  diagnostics: "Your app has insufficient permissions to use this operation. Please contact support."
post:
    summary: Update a patient's coverage
    operationId: post-coverage
    description: |
      ## Overview
      Use this endpoint to get a patient's European Health Insurance Card (EHIC) details. You can only use this endpoint to update EHIC data. A patient may have other financial coverage, like insurance, but this information cannot be added to PDS. 

      There can only be one set of EHIC details on a patient's record at a time. If a patient already has an EHIC record in PDS, the update request will replace the existing EHIC record.
    
      You can only update EHIC details using patient access mode.

      ## Patient resource versioning
      To update a patient's details, use the [get a patient's coverage](///link to get coverage endpoint info here//////) to get a version number for the most up-to-date record. The version number is in the `ETag` response header in the form `W/"2"`.

      You must then pass the patient's version number in the update request, in the `If-Match` response header. If the patient record has been updated in PDS between your first retrieval and the update request, the update will fail.

      When the update succeeds, you will get the updated patient record. This will contain the new resource version number.

      If you make a further update you must use the new version number.
      
      ## JSON Patch
      To update a patient record, a [JSON Patch](https://tools.ietf.org/html/rfc6902) should be sent. A JSON Patch consists of one or more patch objects within a list.

      All updates should be sent together in a single request as a list of patches. This is the most efficient way. It also reduces the danger of race conditions occurring when updating the patient record multiple times in a short period of time.

      When processing the list of patch objects, each patch must be valid and pass all the business rules against the data. If one patch object fails, none of the patch objects will be applied.

      A patch object consists of:
      * an operation, `op` - this is required.
      * a path to the data that you want to change, `path` - this is required.
      * the value that is assigned, `value` - this is required for `add`, `replace` and `test`; but should not be included for a `remove`.

      The following operations are supported:
      * `add` - to add a new value.
      * `replace` - to replace an existing value.
      * `remove` - to remove an existing value.
      * `test` - to test the state of a value is as expected before continuing with the update.

      ## Sandbox test scenarios

      You can test the following scenarios in our sandbox environment.

      Things to note when using the sandbox for PATCH:
      * Your changes are not persisted.
      * JSON Patch operations themselves are validated, but the resulting resource is not validated for correctness; meaning any business rules are not applied.
      * You can use the patient with minimal data, `9000000033` to test adding all data types (as most of them are missing on this patient), that would normally be present.

      | Scenario                            | Request                                                                   | Response                                         |
      | ----------------------------------- | ------------------------------------------------------------------------- | ------------------------------------------------ |
      | Successful update                   | `id`=`9000000009`<br><br>Body: One of the provided examples or your own combination of patches<br><br>Headers: `If-Match`=`W/"2"`, `Content-Type`=`application/json-patch+json` | HTTP Status 200 with updated patient resource. |
      | Patient does not exist               | `id`=`9111231130` (or any other valid NHS number)                         | HTTP Status 404 with problem description         |
      | Invalid NHS number                  | `id`=`9000000000` (or any invalid NHS number)                             | HTTP Status 400 with problem description         |
      | Missing resource version identifier | `If-Match` header missing or set to format other than `W/"<version>"`     | HTTP Status 412 with problem description         |
      | Incorrect resource version          | `If-Match`=`W/"1"`                                                        | HTTP Status 412 with problem description         |
      | Wrong content type                  | `Content-Type` header missing or other than `application/json-patch+json` | HTTP Status 400 with problem description         |
      | No patches sent                     | Send body with no `patches` attribute                                     | HTTP Status 400 with problem description         |
      | Invalid patch operations            | Send body with invalid JSON patches in `patches` attribute                | HTTP Status 400 with problem description         |
      | Missing X-Request-ID                | `id`=`9000000009` (or any other valid NHS number)                         | HTTP Status 400 with problem description         |

      You can try out the sandbox by selecting the 'Try' button on this page.

      Alternatively, you can try out the sandbox using our Postman collection:
      
      [![Run in Postman](https://run.pstmn.io/button.svg)](https://app.getpostman.com/run-collection/32547823-005ebee4-7510-44c3-bb0e-58f26b2ba747)


    parameters:
      - $ref: '#/components/parameters/IfMatch'
    requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "components/schemas/Coverage.yaml"
    responses:
      '2XX':
        description: |
          A completed update to coverage. This will contain the Coverage resource just posted in the Bundle.
            | HTTP status | Error code                 | Description                                                                                                                                |
            | ----------- | -------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------ |
            | 200         |                            | Coverage successfully updated
            | 201         |                            | Coverage successfully added

        headers:
          X-Correlation-Id:
            $ref: '#/components/headers/X-Correlation-Id'
          X-Request-Id:
            $ref: '#/components/headers/X-Request-Id'
        content:
          application/fhir+json:
            schema:
              $ref: 'components/schemas/CoverageSearch.yaml'

      '4XX':
        description: |
            An error occurred as follows:

            | HTTP status | Error code                 | Description                                                                                                                                |
            | ----------- | -------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------ |
            | 400         | MISSING_VALUE              | Missing header or value in the body. For details, see the `diagnostics` field.
            | 400         | INVALID_VALUE              | Invalid header or value in the body. For details, see the `diagnostics` field.
            | 400         | INVALID_UPDATE             | Malformed request body or client error after the update was accepted and patient was not updated.
            | 400         | INVALID_RESOURCE_ID        | Invalid NHS number.
            | 400         | VALIDATION_ERROR           | This is the "default" error thrown when no others are applicable.
            | 401         | ACCESS_DENIED              | Access token missing, invalid or expired, or calling application not configured for this operation (ASID not set for interaction)
            | 404         | RESOURCE_NOT_FOUND         | Patient does not exist for given NHS number.
            | 408         | UNABLE_TO_CALL_SERVICE     | The downstream domain processing has not completed within the configured timeout period.
            | 409         | RESOURCE_VERSION_MISMATCH  | The resource version in the If-Match header of the update request did not match the current version of the resource. See Patient resource versioning.
            | 429         | TOO_MANY_REQUESTS          | You have exceeded your application's [rate limit](https://digital.nhs.uk/developer/guides-and-documentation/reference-guide#rate-limits).
            | 503         | SERVICE_UNAVAILABLE        | The request timed out during processing. This does not imply the request has failed or been rejected.
            | 400	        | TOO_FEW_VALUES_SUBMITTED	 | The field in question has a minimum number of items and the user sent too few.
            | 400	        | TOO_MANY_VALUES_SUBMITTED	 | The field in question has a maximum number of items and the user sent too many.
            | 403	        | FORBIDDEN_UPDATE	         | The user is not permitted to update certain resources or elements, for example most users are not allowed to update the date of death once it has been set. A detailed description will be added to the display. For example - updating a sensitive patient or adding a formal death notification is only permitted from certain systems.
            | 403	        | ACCESS_DENIED	             | Patient cannot perform this action.
            | 412	        | PRECONDITION_FAILED	       | Problem with request, for example missing If-Match header. For details, see the diagnostics field.
        headers:
          X-Correlation-Id:
            $ref: '#/components/headers/X-Correlation-Id'
          X-Request-Id:
            $ref: '#/components/headers/X-Request-Id'

        content:
          application/fhir+json:
            schema:
              $ref: '#/components/schemas/OperationOutcome'
            example:
              resourceType: OperationOutcome
              issue:
                - severity: error
                  code: forbidden
                  details:
                    coding:
                      - system: 'https://fhir.nhs.uk/R4/CodeSystem/Spine-ErrorOrWarningCode'
                        version: '1'
                        code: ACCESS_DENIED
                        display: Cannot POST resource with user-restricted access token
                  diagnostics: "Your app has insufficient permissions to use this operation. Please contact support."