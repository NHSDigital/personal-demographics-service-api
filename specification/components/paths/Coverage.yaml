parameters:
  - $ref: '#/components/parameters/BearerAuthorization'
  - $ref: '#/components/parameters/RoleId'
  - $ref: '#/components/parameters/RequestID'
  - $ref: '#/components/parameters/CorrelationID'
  - $ref: '#/components/parameters/NHSD-End-User-Organisation-ODS'
get:
    summary: Get a patient's coverage
    operationId: get-coverage
    description: |
      ## Overview
      Use this endpoint to get a patient's European Health Insurance Card (EHIC) details. Use the patient's NHS number as the identifier for coverage.

      This endpoint only gives EHIC data in the coverage data fields. A patient may have other financial coverage, like insurance, but this information will not be returned by PDS. 

      You can only use this endpoint if you are using patient access mode (for specific use cases only). 
        
      ## Superseded patients
      Some patients are marked as superseded. This means that the original patient details are no longer valid and have been replaced with different details.

      When PDS tries to get the EHIC details using the NHS number of a superseded record, it will return the EHIC details of the latest record. You can see this by comparing the value used in the query with the value returned in the response body.

      ## Mandatory fields
      In a coverage get request, there are two mandatory EHIC fields. They are the patient's NHS Number and the unique ID of issuer of the policy. If either of these fields on the patient's record is empty, PDS will not return the patient's EHIC information. If any other EHIC field on the patient's record is empty, PDS will return the patient's EHIC information without those fields.

      ## Sandbox test scenarios
        You can test the following scenarios in our sandbox environment:

        | Scenario                        | Request                                       | Response                                                      |
        | ------------------------------- | --------------------------------------------- | ------------------------------------------------------------- |
        | xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx  | `id`=``                                       | xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx |
        | xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx  | `id`=``                                       | xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx |
        | xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx  | `id`=``                                       | xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx |
        | xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx  | `id`=``                                       | xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx |

        You can try out the sandbox by selecting the 'Try' button on this page.

        Alternatively, you can try out the sandbox using our Postman collection:
        
        [![Run in Postman](https://run.pstmn.io/button.svg)](https://)

   
    parameters:
      SubscriberIdentifier:
        name: subscriber:identifier
        description: |
          The NHS number that identifies the holder/subscriber of the coverage.
        examples:
          ehic_holder:
            value: 9733162868
            summary: Returns a bundle that contains a Coverage resource for the patient with NHS number 9733162868.
          no_ehic:
            value: 9733162876
            summary: Returns an empty bundle, alongside a meta object that can be used to apply an update to the patient's coverage.
        in: query
        required: true
        schema:
          type: string
    responses:
      '200':
        description: |
          A completed search for coverage. This will contain zero or one Coverage resources in the Bundle.

        headers:
          X-Correlation-Id:
            $ref: '#/components/headers/X-Correlation-Id'
          X-Request-Id:
            $ref: '#/components/headers/X-Request-Id'
        content:
          application/fhir+json:
            schema:
              $ref: 'components/schemas/CoverageSearch.yaml'

      '4XX':
        description: |
            An error occurred as follows:

            | HTTP status | Error code                 | Description                                                                                                                                |
            | ----------- | -------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------ |
            | 400         | INVALID_SEARCH_DATA	       | Invalid combination of search parameters. For details, see the `diagnostics` field.
            | 400         | MISSING_VALUE              | Missing header or query parameter. For details, see the `diagnostics` field.
            | 400         | INVALID_VALUE              | Invalid header or query parameter. For details, see the `diagnostics` field.
            | 401         | ACCESS_DENIED     	       | Access token missing, invalid or expired, or calling application not configured for this operation.
            | 403         | ACCESS_DENIED     	       | User cannot perform this operation.
            | 404         | RESOURCE_NOT_FOUND         | Patient does not exist for given NHS number.
            | 404         | INVALIDATED_RESOURCE       | Patient did exist for given NHS number, but has been invalidated and not superseded by another NHS number.
            | 408         | UNABLE_TO_CALL_SERVICE     | The downstream domain processing has not completed within the configured timeout period.
            | 429         | TOO_MANY_REQUESTS          | You have exceeded your application's [rate limit](https://digital.nhs.uk/developer/guides-and-documentation/reference-guide#rate-limits).

        headers:
          X-Correlation-Id:
            $ref: '#/components/headers/X-Correlation-Id'
          X-Request-Id:
            $ref: '#/components/headers/X-Request-Id'

        content:
          application/fhir+json:
            schema:
              $ref: '#/components/schemas/OperationOutcome'
            example:
              resourceType: OperationOutcome
              issue:+-
                - severity: error
                  code: forbidden
                  details:
                    coding:
                      - system: 'https://fhir.nhs.uk/R4/CodeSystem/Spine-ErrorOrWarningCode'
                        version: '1'
                        code: ACCESS_DENIED
                        display: Cannot GET resource with user-restricted access token
                  diagnostics: "Your app has insufficient permissions to use this operation. Please contact support."
post:
    summary: Update a patient's coverage
    operationId: post-coverage
    description: |
      ## Overview
      Use this endpoint to update a patient's European Health Insurance Card (EHIC) details. A patient may have other financial coverage, like insurance, but this information cannot be added to PDS.  

      There can only be one set of EHIC details on a patient's record at a time. If a patient already has an EHIC record in PDS, the update request will replace the existing EHIC record. When a user adds a new EHIC record to PDS, they must enter information for all the EHIC data fields.  
    
      You can only update EHIC details using patient access mode (for specific use cases only). 

      ## Patient resource versioning
      To update a patient's details, use the `get a patient's coverage` operation to get a version number for the most up-to-date details. The version number is in the `ETag` response header in the form `W/"2"`.

      You must then pass the patient's version number in the update request, in the `If-Match` response header. If the coverage details have been updated in PDS between your first retrieval and the update request, the update will fail.

      When the update succeeds, you will get the updated coverage details. This will contain the new resource version number.

      If you make a further update you must use the new version number.

      ## Sandbox test scenarios

      You can test the following scenarios in our sandbox environment.

      | Scenario                            | Request                                                                   | Response                                         |
      | ----------------------------------- | ------------------------------------------------------------------------- | ------------------------------------------------ |
      | Successful update                   | `id`=`9000000009`<br><br>Body: One of the provided examples or your own combination of patches<br><br>Headers: `If-Match`=`W/"2"`, `Content-Type`=`application/json-patch+json` | HTTP Status 200 with updated patient resource. |
      | Patient does not exist               | `id`=`9111231130` (or any other valid NHS number)                         | HTTP Status 404 with problem description         |
      | Invalid NHS number                  | `id`=`9000000000` (or any invalid NHS number)                             | HTTP Status 400 with problem description         |
      | Missing resource version identifier | `If-Match` header missing or set to format other than `W/"<version>"`     | HTTP Status 412 with problem description         |
      | Incorrect resource version          | `If-Match`=`W/"1"`                                                        | HTTP Status 412 with problem description         |
      | Wrong content type                  | `Content-Type` header missing or other than `application/json-patch+json` | HTTP Status 400 with problem description         |
      | No patches sent                     | Send body with no `patches` attribute                                     | HTTP Status 400 with problem description         |
      | Invalid patch operations            | Send body with invalid JSON patches in `patches` attribute                | HTTP Status 400 with problem description         |
      | Missing X-Request-ID                | `id`=`9000000009` (or any other valid NHS number)                         | HTTP Status 400 with problem description         |

      You can try out the sandbox by selecting the 'Try' button on this page.

      Alternatively, you can try out the sandbox using our Postman collection:
      
      [![Run in Postman](https://run.pstmn.io/button.svg)](https://app.getpostman.com/run-collection/32547823-005ebee4-7510-44c3-bb0e-58f26b2ba747)


    parameters:
      - $ref: '#/components/parameters/IfMatch'
    requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "components/schemas/Coverage.yaml"
    responses:
      '2XX':
        description: |
          A completed update to coverage. This will contain the Coverage resource just posted in the Bundle.
            | HTTP status | Error code                 | Description                                                                                                                                |
            | ----------- | -------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------ |
            | 200         |                            | Coverage successfully updated
            | 201         |                            | Coverage successfully added

        headers:
          X-Correlation-Id:
            $ref: '#/components/headers/X-Correlation-Id'
          X-Request-Id:
            $ref: '#/components/headers/X-Request-Id'
        content:
          application/fhir+json:
            schema:
              $ref: 'components/schemas/CoverageSearch.yaml'

      '4XX':
        description: |
            An error occurred as follows:

            | HTTP status | Error code                 | Description                                                                                                                                |
            | ----------- | -------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------ |
            | 400         | MISSING_VALUE              | Missing header or value in the body. For details, see the `diagnostics` field.
            | 400         | INVALID_VALUE              | Invalid header or value in the body. For details, see the `diagnostics` field.
            | 400         | INVALID_UPDATE             | Malformed request body or client error after the update was accepted and patient was not updated.
            | 400         | INVALID_RESOURCE_ID        | Invalid NHS number.
            | 400         | VALIDATION_ERROR           | This is the "default" error thrown when no others are applicable.
            | 400	        | TOO_FEW_VALUES_SUBMITTED	 | The field in question has a minimum number of items and the user sent too few.
            | 400	        | TOO_MANY_VALUES_SUBMITTED	 | The field in question has a maximum number of items and the user sent too many.
            | 401         | ACCESS_DENIED              | Access token missing, invalid or expired, or calling application not configured for this operation (ASID not set for interaction)
            | 403	        | FORBIDDEN_UPDATE	         | The user is not permitted to update certain resources or elements, for example most users are not allowed to update the date of death once it has been set. A detailed description will be added to the display. For example - updating a sensitive patient or adding a formal death notification is only permitted from certain systems.
            | 404         | RESOURCE_NOT_FOUND         | Patient does not exist for given NHS number.
            | 408         | UNABLE_TO_CALL_SERVICE     | The downstream domain processing has not completed within the configured timeout period.
            | 409         | RESOURCE_VERSION_MISMATCH  | The resource version in the If-Match header of the update request did not match the current version of the resource. See Patient resource versioning.
            | 412	        | PRECONDITION_FAILED	       | Problem with request, for example missing If-Match header. For details, see the diagnostics field.
            | 429         | TOO_MANY_REQUESTS          | You have exceeded your application's [rate limit](https://digital.nhs.uk/developer/guides-and-documentation/reference-guide#rate-limits).

        headers:
          X-Request-Id:
            $ref: '#/components/headers/X-Request-Id'

        content:
          application/fhir+json:
            schema:
              $ref: '#/components/schemas/OperationOutcome'
            example:
              resourceType: OperationOutcome
              issue:
                - severity: error
                  code: forbidden
                  details:
                    coding:
                      - system: 'https://fhir.nhs.uk/R4/CodeSystem/Spine-ErrorOrWarningCode'
                        version: '1'
                        code: ACCESS_DENIED
                        display: Cannot POST resource with user-restricted access token
                  diagnostics: "Your app has insufficient permissions to use this operation. Please contact support."

      '503':
        description: |
            The request timed out during processing. This does not imply the request has failed or been rejected. Error code: `SERVICE_UNAVAILABLE`.
            Re-send the request after the time specified in the `Retry-After` header using the same `X-Request-ID` value.
        headers:
          RetryAfter:
             $ref: '#/components/headers/RetryAfter'
          X-Request-Id:
            $ref: '#/components/headers/X-Request-Id'

        content:
          application/fhir+json:
            schema:
              $ref: '#/components/schemas/OperationOutcome'
            example:
              resourceType: OperationOutcome
              issue:
                - severity: timeout
                  details:
                    coding:
                      - system: 'https://fhir.nhs.uk/R4/CodeSystem/Spine-ErrorOrWarningCode'
                        version: '1'
                        code: SERVICE_UNAVAILABLE
                        display: Service unavailable
                  diagnostics: "The downstream domain processing has not completed within the configured timeout period. Using the same 'X-Request-ID' header, retry your request after the time specified by the 'Retry-After' response header."